<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>BIM Viewer Pro - Rhino Style</title>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; font-family: 'Inter', sans-serif; background: #f5f5f7; }
        canvas { width: 100vw; height: 100vh; display: block; }
        
        #menu {
            position: absolute; top: 20px; left: 20px;
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px);
            padding: 15px; border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            z-index: 100; width: 220px; border: 1px solid rgba(255,255,255,0.3);
        }

        h3 { margin: 0 0 12px 0; font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 1px; }
        
        .group { margin-bottom: 15px; display: flex; flex-direction: column; gap: 5px; }

        button {
            width: 100%; padding: 10px; border: 1px solid #eee; border-radius: 8px;
            background: white; cursor: pointer; transition: 0.2s;
            font-size: 13px; font-weight: 500; text-align: left;
        }
        button:hover { background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        button.active { background: #007aff; color: #fff; border-color: #007aff; }
        
        .hint { font-size: 11px; color: #999; margin-top: 10px; line-height: 1.4; }
    </style>
</head>
<body>

<div id="menu">
    <h3>Affichage</h3>
    <div class="group">
        <button id="btn-mono" class="active" onclick="changeStyle('mono')">‚ö™ Maquette Blanche</button>
        <button id="btn-real" onclick="changeStyle('real')">üé® Textures Rhino</button>
        <button id="btn-wire" onclick="changeStyle('wire')">üï∏Ô∏è Mode Structure</button>
    </div>

    <h3>Outils</h3>
    <div class="group">
        <button onclick="createGumball()">‚ûï Ajouter Coupe (Gumball)</button>
        <button onclick="clearSections()" style="color:#ff3b30">üóëÔ∏è Supprimer les coupes</button>
    </div>

    <div class="hint">
        <b>Gumball :</b> Cliquez sur une fl√®che pour d√©placer le plan de coupe.
    </div>
</div>

<canvas id="myCanvas"></canvas>

<script type="module">
    import {Viewer, GLTFLoaderPlugin, SectionPlanesPlugin} from "https://cdn.jsdelivr.net/npm/@xeokit/xeokit-sdk/dist/xeokit-sdk.es.min.js";

    // 1. Initialisation Performance
    const viewer = new Viewer({
        canvasId: "myCanvas",
        saoEnabled: true, // Ambiant Occlusion
        pbrEnabled: true  // Meilleur rendu des textures
    });

    viewer.scene.sao.intensity = 0.8;

    const loader = new GLTFLoaderPlugin(viewer);
    const sectionPlanes = new SectionPlanesPlugin(viewer, {
        overviewCanvasId: "myCanvas", // Permet l'interaction directe
        active: true
    });

    // 2. Chargement
    const model = loader.load({
        id: "myModel",
        src: "./projet1.glb",
        edges: true,
        performance: true // Optimise le FPS
    });

    model.on("loaded", () => {
        viewer.cameraFlight.jumpTo(model);
        // Force l'application du style blanc apr√®s un court d√©lai pour √™tre s√ªr que les IDs sont l√†
        setTimeout(() => changeStyle('mono'), 500);
    });

    // 3. Syst√®me de Styles (Corrig√© pour fonctionner √† 100%)
    window.changeStyle = (style) => {
        const allIds = viewer.scene.objectIds;
        
        // Reset boutons
        document.querySelectorAll('button').forEach(b => b.classList.remove('active'));
        
        if (style === 'mono') {
            document.getElementById('btn-mono').classList.add('active');
            viewer.scene.setObjectsColor(allIds, [1, 1, 1]);
            viewer.scene.setObjectsOpacity(allIds, 1.0);
            viewer.scene.edgeMaterial.edges = true;
        } 
        else if (style === 'real') {
            document.getElementById('btn-real').classList.add('active');
            viewer.scene.setObjectsColor(allIds, null); // Restaure les textures originales
            viewer.scene.edgeMaterial.edges = false;
        } 
        else if (style === 'wire') {
            document.getElementById('btn-wire').classList.add('active');
            viewer.scene.setObjectsColor(allIds, [0.2, 0.2, 0.2]);
            viewer.scene.setObjectsOpacity(allIds, 0.3);
            viewer.scene.edgeMaterial.edges = true;
        }
    };

    // 4. Gumball Rhino (Section Plane Control)
    let planeCount = 0;
    window.createGumball = () => {
        const plane = sectionPlanes.createSectionPlane({
            id: "plane" + planeCount++,
            pos: [0, 0, 0],
            dir: [0, -1, 0] // Coupe horizontale par d√©faut
        });
        
        // Active le "Gumball" (les fl√®ches de manipulation)
        sectionPlanes.showControl(plane.id);
    };

    window.clearSections = () => {
        sectionPlanes.clear();
        planeCount = 0;
    };

    // 5. Am√©lioration Fluidit√© (Cam√©ra)
    viewer.cameraControl.followPointer = true;
    viewer.cameraControl.smartPivot = true;

</script>
</body>
</html>
